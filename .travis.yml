# Use the (faster) container-based infrastructure, see also
# http://docs.travis-ci.com/user/workers/container-based-infrastructure/
sudo: false

language: go
go:
  - 1.8

env:
  global:
  # GITHUB_USER
  - secure: "Gh2YKPSLuCK06ji+fYccWv9sKpKRRqOq9/d0V2vxXK08qKhiB5lnUlOwKIgHYvA6Y9quPhwnoRqaXX3es4ciHq+CvoHMUBYEy4NtS5Lr/aWYvXEEaiICdcULv+991xDsudJZ8g58j20XBvBWi28GuGlcY629G8JRKqYzhRzUZ0zl9XUDEzaYzhM4yCsSRHKlY27J6/qaHBaWO3EDJKJzDBFa09HhX3G49ES3W5ArtntgsYM3I30L0KaZAKuxoXBjjLJn+MiufUwpBtFJSr7AxBICWQmHcUBkS70e8JeQkeB2a+7Xj/Z+2yiZlpHWXJlOD57zykTgWKmVzKP/ki6Ky+NGub1XDP5JyJ8QBlzRkqG8isxyl8aiC+JAKqKyhBAHIOHAcfkqoonNLoPdGiODEE56ebSjtrnUNQW4UHiO3UFHclc3HFBhzASmJgsLTa+MVZ7KBhLKaAI95P4ykVRDL+lpc6lj0IjfXUWuo1nIXX6cKtD/OaludrQhzmFUlwM5l9misLjlvEMpMA17NfE7u7jqTY3WGRdX8crKaS/8OUxMmvSolk3IC6O2PCLa97ZRbM5vB9Yv6JXcuRS/UPONfVeCWaQMNmOGeWyIcjIVUTikTjLbm1CDGKh/uR/igvCQ0JRV7MDD8R1NE75+IeY0PD0ZIiNZ5nVYJelQTY7mMCI="
  # GITHUB_AUTH_TOKEN
  - secure: "tZMezsUCNLDE1uwShen2omADxYbWv7lS21lM+GwQBSPhWQgOx9wzpegDEyV1PxoWqYqASuEPQYxA9+B80S/guCiBCXXdxbOFEbhd+Uj5PlNI2bB2AaWrUwsa3nNtM+CwKp9cikB+zOSqw24ibrpS6VNKd+gBGOOTTLj3VXvWoNGT6vmBeIqUkEc6oGto4RunQ5uz7Z8aggs/mv9Mzi2ClzPDEtb0efqrxVJpxMP/bzo0zdOh+x4gNZtVKdPHu2YjNK+bCF9S7V4g5+kXEblOMcY/zgn1UlHE14ErqCLJLf3sb+HUMS5XIMypHMX1cpKrSU9pq4/LlQGAuGMuIIghXT9CXW4+ClNH4jdYhpob1PFUYEFe1T/yD7Y9zQVPb9w5ZR/CpkO7w4ppq9QE+lVRa1+AcZyJt0HvY6X2fi7JP+c403OReKRBt9yhFFRcUXGxJbrSs+fLHpLUtGZospMrACdV31wo6KqmnlfMjTn2o8J0NQHlt1UG3/Qs/buobuQUmNCTkwwx6JMjzRPiSPC7kWHN++a2eG5QpZ/7YmOj9SE8eGCjlrdOloqkpa3cl1gW8+DBeAVkYe4dXTY7fF0wrpDZa6UObReEvpiP+D+33gkEMDzX1+W5czxxu4Bn4KBZLbes9TJLc7MPJv5+AJFmmXSXwZFcNhyt5AfdwWrM1Ts="
  # BOOTERY_URL
  - secure: "y81568aE1HhepG6wSizRpFi/kmXfRqAacO6XNYeVeGcFVD6ECxiGsKJtCNOg6G5APwrz1Wx7EGwyt2t41uo7/nRhpK8dTzAXuU7YfnGKOlL/mtEtiyI567rO2ycLRXJz5VfW72DzAmHOjSuC06Fksig9GQmkd8MroVK1PyJaWPCCJ06Qv2eoFv6LeaDz6ZB3imvSTgNG5bw1ys+tdz+/0wkEpOQA5kJcWB9HtMNprd11L1/dcXEr6R1psWarHOWmqnh8GDHKjFAkrP3xnZdhN5DUlEtLL98nP90bPodxvBsuUCyMevfEJUoxFn8LRd9dpJs7KcHGG+L4zykO8zXeJle1StQ9yxt/yC8HHvOk4LXhiPQD9r5PBwUaN2jEGPYNFbrsleAFAvPgsfyuDVeZ6ZRSxFmwWWFoAR0Gp4ccEE7IKqEBhQJkGtCf38NLrOciQlrgCQa6w/x2HhVlw9kOLuLvf9p+z3lPd/UcEJqpGz2x50nwYjCaFY6mlKpT8nvo6R2ZM5u94houBdJ3PM6DxrnozH5X2kLg33L224/On/dyXLFgbMRCDTnkx5STBpRtlZK69B6m+AeLBjIf8HXzxR6Aw3ZFlRZOTyOypL0skY08OfVhNftx4fDvAZpSxXFqdJ0IfBJn5UV5i1aKM9NaiiXe3DDuWu2gc6GXUA9jHWc="

script:
  # Check whether files are syntactically correct.
  - "gofmt -l $(find . -name '*.go' | tr '\\n' ' ') >/dev/null"
  # Check whether files were not gofmt'ed.
  - gosrc=$(find . -name '*.go' | tr '\\n' ' '); [ $(gofmt -l $gosrc 2>&- | wc -l) -eq 0 ] || (echo 'gofmt was not run on these files:'; gofmt -l $gosrc 2>&-; false)
  - '[ "$TRAVIS_SECURE_ENV_VARS" != "true" ] || go get -u github.com/gokrazy/autoupdate/cmd/... github.com/gokrazy/tools/cmd/gokr-packer'
  - '[ "$TRAVIS_SECURE_ENV_VARS" != "true" ] || (gokr-boot -require_label=please-boot -set_label=please-merge -bootery_url=$BOOTERY_URL; ret=$?; if [ $ret -eq 0 ]; then exit 0; elif [ $ret -eq 1 ]; then exit 1; else true; fi)'
  - '[ "$TRAVIS_SECURE_ENV_VARS" != "true" ] || (gokr-merge -require_label=please-merge; ret=$?; if [ $ret -eq 0 ]; then exit 0; elif [ $ret -eq 1 ]; then exit 1; else true; fi)'
  # Update firmware files
  - go install ./cmd/gokr-update-firmware
  - gokr-update-firmware
  # update pull request
  - '[ "$TRAVIS_SECURE_ENV_VARS" != "true" ] || (go get -u github.com/gokrazy/autoupdate/cmd/gokr-amend && gokr-amend -set_label=please-boot *.bin *.elf *.dat)'
